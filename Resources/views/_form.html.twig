{% trans_default_domain "victoire" %}
{{ form_start(form) }}

<div id="table-data" data-ordered="{{ form.rows|length }}" data-abscissa="{{ form.columnFields|length }}"></div>
<div class="row">
    <div class="col-sm-12">
        <div id="values-redactor-toolbar"></div>
        <ul class="table" id="table">
            <li>
                <ul class="vic-table-row">
                    <li class="vic-table-square"></li>

                    <li class="vic-table-square"></li>

                    {% for fieldColumn in form.columnFields %}
                    <li class="vic-table-square -action" data-abscissa="{{ loop.index0 }}">
                        {% spaceless %}
                            <div class="table-btn -remove table-move-left-column" data-abscissa="{{ loop.index0 }}">
                                <i class="fa fa-arrow-left"></i>
                            </div>
                            <button class="table-btn -remove table-delete-column" data-abscissa="{{ loop.index0 }}">
                                <i class="fa fa-minus-square-o"></i>
                            </button>
                            <div class="table-btn -remove table-move-right-column" data-abscissa="{{ loop.index0 }}">
                                <i class="fa fa-arrow-right"></i>
                            </div>
                        {% endspaceless %}
                    </li>
                    {% endfor %}

                    <li class="vic-table-square -action table-column-placeholder table-column-highlight" id="table-add-column">
                        {% spaceless %}
                        <button class="table-btn" id="table-add-column-btn" data-prototype="{{ form_widget(form.columnFields.vars.prototype.val)|e }}"data-option-prototype="{{ _self.widget_field_option(form.columnFields.vars.prototype.option)|e }}">
                            <i class="fa fa-plus-square-o"></i>
                        </button>
                        {% endspaceless %}
                    </li>
                </ul>
            </li>

            <li>
                <ul class="vic-table-row">
                    <li class="vic-table-square"></li>

                    <li class="vic-table-square"></li>

                    {% for fieldColumn in form.columnFields %}
                    <li class="vic-table-square -field" data-abscissa="{{ loop.index0 }}">
                        {{ form_widget(fieldColumn.val) }}
                    </li>
                    {% endfor %}

                    <li class="vic-table-square table-column-highlight" id="table-row-field-placeholder"></li>
                </ul>
            </li>

            {% for row in form.rows %}
            <li data-ordered="{{ loop.index0 }}">
                <ul class="vic-table-row">
                    <li class="vic-table-square -action" data-ordered="{{ loop.index0 }}">
                        {% spaceless %}
                        <button class="table-btn -remove table-delete-row" data-ordered="{{ loop.index0 }}">
                            <i class="fa fa-minus-square-o"></i>
                        </button>
                        <div class="table-btn -remove table-move-up-row" data-abscissa="{{ loop.index0 }}">
                            <i class="fa fa-arrow-up"></i>
                        </div>
                        <div class="table-btn -remove table-move-down-row" data-abscissa="{{ loop.index0 }}">
                            <i class="fa fa-arrow-down"></i>
                        </div>
                        {% endspaceless %}
                    </li>

                    {{ _self.widget_prototype(row, loop) }}

                    <li class="vic-table-square table-placeholder-row table-column-highlight" data-ordered="{{ loop.index0 }}"></li>
                </ul>
            </li>
            {% endfor %}

            <li>
                <ul class="vic-table-row vic-table-row-highlight" id="vic-table-row-placeholder">
                    <li class="vic-table-square -action " id="table-add-row">
                        {% spaceless %}
                        <button  class="table-btn" id="table-add-row-btn" data-prototype="{{ _self.widget_prototype(form.rows.vars.prototype)|e }}" data-value-prototype="{{ _self.widget_value_prototype(form.rows.vars.prototype.values.vars.prototype)|e }}">
                            <i class="fa fa-plus-square-o"></i>
                        </button>
                        {% endspaceless %}
                    </li>
                    <li class="vic-table-square vic-table-row-highlight" id="table-delete-row-placeholder">{{_self.widget_field_option(form.option)}}</li>

                    {% for fieldRow in form.columnFields %}
                    <li class="vic-table-square table-placeholder-column vic-table-row-highlight" data-abscissa="{{ loop.index0 }}">{{_self.widget_field_option(fieldRow.option)}}</li>
                    {% endfor %}

                    <li class="vic-table-square table-column-placeholder" id="vic-table-square-corner"></li>
                </ul>
            </li>
        </ul>
        {{form_widget(form.fullWidth)}}
    </div>
    
    <div class="hidden">
        {{ form_row(form.rows) }}
        {{ form_row(form.columnFields) }}
    </div>

    <div class="vic-alert vic-alert-info vic-alert-dismissible">
        <strong>{{'widget.table.help.title'|trans}}</strong>
        <br>
        {{'widget.table.help.content'|trans}}
    </div>


    {{ form_end(form) }}

</div>






<div class="hidden" id="prototype-delete-row">
    <li class="vic-table-square -action" data-ordered="__ORDERED__">
        {% spaceless %}
            <button class="table-btn -remove table-delete-row" data-ordered="__ORDERED__">
                <i class="fa fa-minus-square-o"></i>
            </button>
            <div class="table-btn -remove table-move-up-row" data-abscissa="__ORDERED__">
                <i class="fa fa-arrow-up"></i>
            </div>
            <div class="table-btn -remove table-move-down-row" data-abscissa="__ORDERED__">
                <i class="fa fa-arrow-down"></i>
            </div>
        {% endspaceless %}
    </li>
</div>

<div class="hidden" id="prototype-field-row">
    <li class="vic-table-square -field" data-ordered="__ORDERED__"></li>
</div>

<div class="hidden" id="prototype-placeholder-row">
    <li class="vic-table-square table-placeholder-row table-column-highlight" data-ordered="__ORDERED__"></li>
</div>

<div class="hidden" id="prototype-delete-column">
    <li class="vic-table-square -action" data-abscissa="__ABSCISSA__">
        {% spaceless %}
            <div class="table-btn -remove table-move-left-column" data-abscissa="__ABSCISSA__">
                <i class="fa fa-arrow-left"></i>
            </div>
            <button class="table-btn -remove table-delete-column" data-abscissa="__ABSCISSA__">
                <i class="fa fa-minus-square-o"></i>
            </button>
            <div class="table-btn -remove table-move-right-column" data-abscissa="__ABSCISSA__">
                <i class="fa fa-arrow-right"></i>
            </div>
        {% endspaceless %}
    </li>
</div>

<div class="hidden" id="prototype-field-column">
    <li class="vic-table-square -field" data-abscissa="__ABSCISSA__"></li>
</div>

<div class="hidden" id="prototype-placeholder-column">
    <li class="vic-table-square table-placeholder-column vic-table-row-highlight" data-abscissa="__ABSCISSA__"></li>
</div>

<div class="hidden" id="prototype-value">
    {% spaceless %}
    <li class="vic-table-square vic-table-square-value" data-ordered="__ORDERED__" data-abscissa="__ABSCISSA__">
        Value
    </li>
    {% endspaceless %}
</div>

{% macro widget_prototype(form, loop) %}
    {% if loop %}
        {% set ordered = loop.index0 %}
    {% else %}
        {% set ordered = "__ORDERED__" %}
    {% endif %}

    {% for key, item in form %}
        {% if key == "name" %}
            <li class="vic-table-square -field" data-ordered="{{ ordered }}">
                {{ form_widget(form.name) }}
            </li>
        {% endif %}

        {% if key == "values" %}
            {% for value in form.values %}
                {{ _self.widget_value_prototype(value, loop, ordered) }}
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{% macro widget_value_prototype(form, loop, ordered) %}
    {% if loop %}
        {% set abscissa = loop.index0 %}
    {% else %}
        {% set abscissa = "__ABSCISSA__" %}
    {% endif %}

    <li class="vic-table-square vic-table-square-value" data-ordered="{{ ordered|default('__ORDERED__') }}" data-abscissa="{{ abscissa }}">
        {{ form_widget(form.val, {'attr' : {'onclick' : "loadRedactor{{ form.vars.ide(this);"}}) }}
    </li>
{% endmacro %}

{% macro widget_field_option(form) %}
    <div class="text-center table-popover-field">
        <div class="table-option-percent">
            <div class="table-option-percent-value">
                {{form.percent.vars.value}}
            </div>
            <div class="table-option-percent-form">
                {{form_widget(form.percent)}}
            </div>
        </div>

    </div>
{% endmacro %}

<script type="text/javascript">
    var buttons =
    [
        'bold', 'italic', 'deleted','unorderedlist', 'orderedlist', 'link', 'alignment', 'fontcolor', 'backcolor', 'fontsize', 'fontfamily'
    ];
    $vic(document).ready(function() {
        $vic('form[name="{{ form.vars.name }}"] .vic-table-square-value').children().each(function(){
            loadRedactor{{ form.vars.id }}(this, 'hidden');
        });
        $vic('form[name="{{ form.vars.name }}"] .table-option-percent').each(function(){
            var percentForm = $vic(this).children('.table-option-percent-form');
            $vic(this).children('.table-option-percent-value').editable({
                type: 'text',
                emptytext: '{{"widget.table.width.empty"|trans}}',
                placement: 'bottom',
                success: function(response, newValue){
                    $vic(this).siblings('.table-option-percent-form').children('input').val(newValue);
                }
            });
        });
        $vic('form[name="{{ form.vars.name }}"] .table-delete-row').on('click', function(e){
            e.preventDefault();
            var ordered = $vic(this).data('ordered');
            $vic('form[name="{{ form.vars.name }}"] *[data-ordered="' + ordered + '"]:not(#table-data)').remove();
            updateDataGrid{{ form.vars.id }}('ordered', ordered);
        });
        $vic('form[name="{{ form.vars.name }}"] .table-delete-column').on('click', function(e){
            e.preventDefault();
            var abscissa = $vic(this).data('abscissa');
            $vic('form[name="{{ form.vars.name }}"] *[data-abscissa="' + abscissa + '"]:not(#table-data)').remove();
            updateDataGrid{{ form.vars.id }}('abscissa', abscissa);
        });

        $vic('form[name="{{ form.vars.name }}"] #table-add-row-btn').on('click', function(e){
            e.preventDefault();
            var numberColumn = $vic('form[name="{{ form.vars.name }}"] #table-data').data('abscissa');
            var newRow = $vic(setCoordinate{{ form.vars.id }}('<li data-ordered="__ORDERED__"><ul class="vic-table-row"></ul></li>'));
            var newRowContainer = newRow.children('ul');
            var newDeleteRow = setCoordinate{{ form.vars.id }}($vic('#prototype-delete-row').html());
            var newFieldRow = $vic(setCoordinate{{ form.vars.id }}($vic('#prototype-field-row').html()));
            var newPlaceholderRow = setCoordinate{{ form.vars.id }}($vic('#prototype-placeholder-row').html());
            var fieldRowPrototype = setCoordinate{{ form.vars.id }}($vic(this).data('prototype'));
            var valuePrototype = $vic(this).data('value-prototype');
            newRowContainer.append(newDeleteRow);
            newFieldRow.append($vic(fieldRowPrototype));
            newRowContainer.append(newFieldRow);
            for (var i = 0; i < numberColumn; i++) {
                var abscissa = i || '0';
                var newValue = setCoordinate{{ form.vars.id }}(valuePrototype, abscissa, null);
                newRowContainer.append($vic(newValue));
            };
            newRowContainer.append(newPlaceholderRow);
            $vic(newRow).insertBefore($vic('form[name="{{ form.vars.name }}"] #vic-table-row-placeholder').parent('li'));

            $vic('form[name="{{ form.vars.name }}"] .vic-table-square-value[data-ordered="' + $vic('#table-data').data('ordered') + '"]').children().each(function(i){
                loadRedactor{{ form.vars.id }}(this, "hidden");
            });

            $vic(newRow).find('.table-delete-row').on('click', function(){
                var ordered = $vic(this).data('ordered');
                $vic('form[name="{{ form.vars.name }}"] *[data-ordered="' + ordered + '"]:not(#table-data)').remove();
                updateDataGrid{{ form.vars.id }}('ordered', ordered);

            });
            updateData{{ form.vars.id }}('ordered');
        });
        $vic('form[name="{{ form.vars.name }}"] #table-add-column-btn').on('click', function(e){
            e.preventDefault();
            var numberRow = $vic('form[name="{{ form.vars.name }}"] #table-data').data('ordered');
            var valuePrototype = $vic('form[name="{{ form.vars.name }}"] #table-add-row-btn').data('value-prototype');

            var newPlaceholderColumn = setCoordinate{{ form.vars.id }}($vic('#prototype-placeholder-column').html());
            var optionPrototype = setCoordinate{{ form.vars.id }}($vic(this).data('option-prototype'));
            placeholderPrototype = $vic(newPlaceholderColumn);
            placeholderPrototype.append(optionPrototype);

            placeholderPrototype.find('.table-option-percent').each(function(){
                var percentForm = $vic(this).children('.table-option-percent-form');
                $vic(this).children('.table-option-percent-value').editable({
                    type: 'text',
                    emptytext: '{{"widget.table.width.empty"|trans}}',
                    placement: 'bottom',
                    success: function(response, newValue){
                        $vic(this).siblings('.table-option-percent-form').children('input').val(newValue);
                    }
                });
            });
            placeholderPrototype.insertBefore($vic('form[name="{{ form.vars.name }}"] #vic-table-square-corner'));
            $vic('form[name="{{ form.vars.name }}"] #table .table-placeholder-row').each(function(){
                var ordered = ($vic(this).data('ordered') || '0' );
                var newValue = setCoordinate{{ form.vars.id }}(valuePrototype, null, ordered);
                $vic(newValue).insertBefore($vic(this));
            });
            var fieldColumnPrototype = $vic(setPosition{{ form.vars.id }}(setCoordinate{{ form.vars.id }}($vic(this).data('prototype')), 'abscissa'));
            var newFieldColumn = $vic(setCoordinate{{ form.vars.id }}($vic('#prototype-field-column').html()));
            newFieldColumn.append(fieldColumnPrototype);
            newFieldColumn.insertBefore($vic('form[name="{{ form.vars.name }}"] #table-row-field-placeholder'));
            var newDeleteColumn = $vic(setCoordinate{{ form.vars.id }}($vic('#prototype-delete-column').html()));
            newDeleteColumn.insertBefore($vic('form[name="{{ form.vars.name }}"] #table-add-column'));

            $vic('form[name="{{ form.vars.name }}"] .vic-table-square-value[data-abscissa="' + $vic('#table-data').data('abscissa') + '"]').children().each(function(i){
                loadRedactor{{ form.vars.id }}(this, "hidden");
            });

            newDeleteColumn.find('.table-delete-column').on('click', function(){
                var abscissa = $vic(this).data('abscissa');
                $vic('form[name="{{ form.vars.name }}"] *[data-abscissa="' + abscissa + '"]:not(#table-data)').remove();
                updateDataGrid{{ form.vars.id }}('abscissa', abscissa);
            });
            updateData{{ form.vars.id }}('abscissa');
        });
    });
    function loadRedactor{{ form.vars.id }}(elem, toolbarClass)
    {
        if(toolbarClass === "undefined"){
            toolbarClass = '';
        }

        var id = $vic(elem).context.id;
        if ( $vic('form[name="{{ form.vars.name }}"] #values-redactor-toolbar-' + id).length == 0)
        {
            $vic('form[name="{{ form.vars.name }}"] #values-redactor-toolbar').append("<div id=\"values-redactor-toolbar-" + id + "\" class=\"" + toolbarClass + "\"></div>");
        }
        $vic('form[name="{{ form.vars.name }}"] #' + id).redactor({
            buttons : buttons,
            maxHeight: 36,
            minHeight: 36,
            focus: true,
            blurCallback : function(){
                $vic('form[name="{{ form.vars.name }}"] #values-redactor-toolbar-' + id).addClass('hidden');
            },
            focusCallback : function(){
                $vic('#form[name="{{ form.vars.name }}"] values-redactor-toolbar-' + id).removeClass('hidden');
            },
            plugins : ['fontcolor', 'fontfamily', 'fontsize'],
            toolbarExternal: 'form[name="{{ form.vars.name }}"] #values-redactor-toolbar-'+ id
        });
    }

    function setCoordinate{{ form.vars.id }}(prototype, abscissa, ordered) {
        var data = $vic('form[name="{{ form.vars.name }}"] #table-data');
        var abscissa = abscissa || data.data('abscissa');
        var ordered = ordered || data.data('ordered');
        prototype = replaceStringProto{{ form.vars.id }}('__ABSCISSA__', abscissa, prototype);
        prototype = replaceStringProto{{ form.vars.id }}('__ORDERED__', ordered, prototype);
        return prototype;
    }

    function setPosition{{ form.vars.id }}(prototype, type)
    {
        var data = $vic('form[name="{{ form.vars.name }}"] #table-data');
        switch(type){
            case 'ordered':
                return replaceStringProto{{ form.vars.id }}('__POSITION__', data.data('ordered'), prototype);
            break;
            case 'abscissa':
                return replaceStringProto{{ form.vars.id }}('__POSITION__', data.data('abscissa'), prototype);
            break;
            default:
        }
        return prototype;
    }

    function replaceStringProto{{ form.vars.id }}(proto, value, str) {
        return str.replace(new RegExp(proto, 'g'), value);
    }
    function updateData{{ form.vars.id }}(type) {
        var data = $vic('form[name="{{ form.vars.name }}"] #table-data');
        switch(type){
            case 'ordered':
                ordered = data.data('ordered');
                $vic('form[name="{{ form.vars.name }}"] #table-data').data('ordered', ordered + 1);
                $vic('form[name="{{ form.vars.name }}"] #table-data').attr('data-ordered', ordered + 1);
            break;
            case 'abscissa':
                abscissa = data.data('abscissa');
                $vic('form[name="{{ form.vars.name }}"] #table-data').data('abscissa', abscissa + 1);
                $vic('form[name="{{ form.vars.name }}"] #table-data').attr('data-abscissa', abscissa + 1);
            break;
            default:
        }
    }
    function updateDataGrid{{ form.vars.id }}(type, value){
        var data = $vic('form[name="{{ form.vars.name }}"] #table-data');
        switch(type){
            case 'ordered':
                orderedMax = data.data('ordered');
                for (i = value ; i < orderedMax; i++) {
                    $vic('form[name="{{ form.vars.name }}"] *[data-ordered="' + i + '"]').each(function(){
                        var ordered = $vic(this).data('ordered') - 1;
                        $vic(this).data('ordered', ordered);
                        $vic(this).attr('data-ordered', ordered);
                    });
                };
                orderedMax = (orderedMax - 1);
                data.data('ordered', orderedMax);
                data.attr('data-ordered', orderedMax);
            break;
            case 'abscissa':
                abscissaMax = data.data('abscissa');
                for (i = value; i < abscissaMax; i++) {
                    $vic('form[name="{{ form.vars.name }}"] *[data-abscissa="' + i + '"]').each(function(){
                        var abscissa = $vic(this).data('abscissa') - 1;
                        $vic(this).data('abscissa', abscissa);
                        $vic(this).attr('data-abscissa', abscissa);
                    });
                };
                abscissaMax = (abscissaMax - 1);
                data.data('abscissa', abscissaMax);
                data.attr('data-abscissa', abscissaMax);
            break;
            default:
        }

    }
    $vic(document).on('click','form[name="{{ form.vars.name }}"] .table-move-right-column', function(event){
        var column = $vic(this).parents('.vic-table-square')[0];
        var abscissa = $vic(column).data('abscissa');

        if(abscissa < $vic('form[name="{{ form.vars.name }}"] #table-data').data('abscissa')){
            moveTable{{ form.vars.id }}("right", this);
        }
    })
    $vic(document).on('click','form[name="{{ form.vars.name }}"] .table-move-left-column', function(){
        var column = $vic(this).parents('.vic-table-square')[0];
        var abscissa = $vic(column).data('abscissa');

        if(abscissa > 0){
            moveTable{{ form.vars.id }}("left", this);
        }
    })
    $vic(document).on('click','form[name="{{ form.vars.name }}"] .table-move-up-row', function(){
        var row = $vic(this).parents('.vic-table-square')[0];
        var ordered = $vic(row).data('ordered');

        if(ordered > 0){
            moveTable{{ form.vars.id }}("up", this);
        }
    })
    $vic(document).on('click','form[name="{{ form.vars.name }}"] .table-move-down-row', function(){
        var row = $vic(this).parents('.vic-table-square')[0];
        var ordered = $vic(row).data('ordered');

        if(ordered < $vic('#table-data').data('ordered')){
            moveTable{{ form.vars.id }}("down", this);
        }
    })
    function moveTable{{ form.vars.id }}(type, elem){
        var elemToMove = $vic(elem).parents('.vic-table-square')[0];
        var index = 0;
        var indexToSwitch = 0;
        var dataToUse = "";
        var dataToBrowse = "";
        var field = "";
        var allowToSwitch = false;
        switch (type) {
            case "up":
            case "down":
                field = "input";
                dataToUse = "ordered";
                dataToBrowse ="abscissa";
                index = $vic(elemToMove).data(dataToUse);
                break;
            case "left":
            case "right":
                field = "textarea";
                dataToUse = "abscissa";
                dataToBrowse ="ordered";
                index = $vic(elemToMove).data(dataToUse);
                break;
        }
        switch (type) {
            case "up":
            case "left":
                indexToSwitch = index - 1;
                allowToSwitch = indexToSwitch >= 0;
                break;
            case "down":
            case "right":
                indexToSwitch = index + 1;
                allowToSwitch = indexToSwitch < $vic('form[name="{{ form.vars.name }}"] #table-data').data(dataToUse);
                break;
        }
        if(allowToSwitch)
        {
            $vic('form[name="{{ form.vars.name }}"] .vic-table-square-value[data-' + dataToUse + '="' + index + '"]').each(function(i){
                var elemToSwitch = $vic('form[name="{{ form.vars.name }}"] .vic-table-square-value[data-' + dataToUse + '="' + indexToSwitch + '"][data-' + dataToBrowse + '="' + i + '"]');
                var elemToSwitchValue = elemToSwitch.find('textarea').redactor('code.get');
                elemToSwitch.find('textarea').redactor('code.set', $vic(this).find('textarea').redactor('code.get') );
                $vic(this).find('textarea').redactor('code.set', elemToSwitchValue );
            });

            var elemToSwitchField = $vic('form[name="{{ form.vars.name }}"] .vic-table-square.-field[data-' + dataToUse + '="' + indexToSwitch + '"]').find(field);
            var currentField = $vic('form[name="{{ form.vars.name }}"] .vic-table-square.-field[data-' + dataToUse + '="' + index + '"]').find(field);
            var elemToSwitchFieldValue = elemToSwitchField.val();
            elemToSwitchField.val(currentField.val());
            currentField.val(elemToSwitchFieldValue);
        }
    }

    {% if form.vars.data.id is null %}
        var numberColumn = $vic('form[name="{{ form.vars.name }}"] #table-data').data('abscissa');
        var numberRow =  $vic('form[name="{{ form.vars.name }}"] #table-data').data('ordered');
        if (numberColumn < 2) {
            for (var i = numberColumn; i < 2; i++) {
                $vic('form[name="{{ form.vars.name }}"] #table-add-column-btn').click();
            };
        };
        if (numberRow < 2) {
            for (var i = numberRow; i < 2; i++) {
                $vic('form[name="{{ form.vars.name }}"] #table-add-row-btn').click();
            };
        };
    {% endif %}
</script>
